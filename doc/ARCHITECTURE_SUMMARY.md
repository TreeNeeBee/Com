# Comæ¨¡å—æ¶æ„åˆ†ææ€»ç»“

## é—®é¢˜1: å½“å‰å·²å®Œæˆéƒ¨åˆ†çš„æ¶æ„è¯´æ˜

### æ¶æ„å…¨æ™¯

Comæ¨¡å—é‡‡ç”¨**åˆ†å±‚æ¶æ„**è®¾è®¡ï¼Œä»ä¸Šåˆ°ä¸‹åˆ†ä¸º4å±‚ï¼š

```
åº”ç”¨å±‚ (Application)
    â†“
ç»Ÿä¸€APIå±‚ (Public API)
    â†“
ä¼ è¾“ç»‘å®šå±‚ (Transport Binding)
    â†“
å¤–éƒ¨åº“å±‚ (External Libraries)
```

### å·²å®Œæˆç»„ä»¶æ¸…å•

#### 1. Public APIå±‚ (source/inc/)

| ç»„ä»¶ | åŠŸèƒ½ | ä»£ç é‡ |
|------|------|--------|
| `Runtime.hpp` | æœåŠ¡å‘ç°ã€è¿è¡Œæ—¶ç®¡ç† | ~200è¡Œ |
| `ProxyBase.hpp` | å®¢æˆ·ç«¯ä»£ç†åŸºç±» | ~250è¡Œ |
| `SkeletonBase.hpp` | æœåŠ¡ç«¯éª¨æ¶åŸºç±» | ~270è¡Œ |
| `Method.hpp` | æ–¹æ³•è°ƒç”¨æŠ½è±¡ | ~450è¡Œ |
| `Event.hpp` | äº‹ä»¶å‘å¸ƒ/è®¢é˜…æŠ½è±¡ | ~350è¡Œ |
| `Field.hpp` | å­—æ®µè®¿é—®æŠ½è±¡ | ~550è¡Œ |
| `Serialization.hpp` | åºåˆ—åŒ–æ¡†æ¶æ¥å£ | ~670è¡Œ |
| `ComTypes.hpp` | é€šç”¨ç±»å‹å’Œé”™è¯¯ç  | ~400è¡Œ |

**æ€»è®¡**: ~3,140è¡Œï¼Œæä¾›AUTOSARæ ‡å‡†çš„ç»Ÿä¸€é€šä¿¡æ¥å£

#### 2. D-Bus Bindingå±‚ (source/binding/dbus/)

| ç»„ä»¶ | åŠŸèƒ½ | ä»£ç é‡ |
|------|------|--------|
| `DBusConnectionManager.hpp` | D-Busè¿æ¥ç®¡ç† | ~200è¡Œ |
| `DBusMethodBinding.hpp` | æ–¹æ³•æœåŠ¡ç«¯/å®¢æˆ·ç«¯ | ~250è¡Œ |
| `DBusEventBinding.hpp` | ä¿¡å·å‘å¸ƒ/è®¢é˜… | ~200è¡Œ |
| `DBusFieldBinding.hpp` | å±æ€§è¯»å†™ | ~300è¡Œ |

**æ€»è®¡**: ~950è¡Œï¼Œå®Œæ•´çš„D-Busæ‰‹åŠ¨ç»‘å®šå®ç°

#### 3. SOME/IP Bindingå±‚ (source/binding/someip/)

| ç»„ä»¶ | åŠŸèƒ½ | ä»£ç é‡ |
|------|------|--------|
| `SomeIpConnectionManager.hpp` | vsomeipåº”ç”¨ç®¡ç† | 270è¡Œ |
| `SomeIpMethodBinding.hpp` | æ–¹æ³•è°ƒç”¨å™¨/å“åº”å™¨ | 450è¡Œ |
| `SomeIpEventBinding.hpp` | äº‹ä»¶è®¢é˜…/å¹¿æ’­/è¿‡æ»¤ | 380è¡Œ |
| `SomeIpFieldBinding.hpp` | å­—æ®µè®¿é—®/é€šçŸ¥ | 490è¡Œ |

**æ€»è®¡**: 1,590è¡Œï¼Œå®Œæ•´çš„SOME/IPæ‰‹åŠ¨ç»‘å®šå®ç°

#### 4. CommonAPI Adapters (source/binding/commonapi/)

| ç»„ä»¶ | åŠŸèƒ½ | ä»£ç é‡ |
|------|------|--------|
| `CommonAPIDBusAdapter.hpp` | D-Busé€‚é…å™¨ | ~350è¡Œ |
| `CommonAPISomeIpAdapter.hpp` | SOME/IPé€‚é…å™¨ | ~420è¡Œ |

**æ€»è®¡**: ~770è¡Œï¼Œæ¡¥æ¥CommonAPIç”Ÿæˆä»£ç ä¸LightAP API

#### 5. æµ‹è¯•ä»£ç 

| ç±»å‹ | æ–‡ä»¶æ•° | æµ‹è¯•ç”¨ä¾‹æ•° | ä»£ç é‡ |
|------|--------|-----------|--------|
| D-Buså•å…ƒæµ‹è¯• | 3 | 22+ | ~600è¡Œ |
| SOME/IPå•å…ƒæµ‹è¯• | 3 | 47+ | ~1,200è¡Œ |
| ç¤ºä¾‹ä»£ç  | 9 | - | ~1,200è¡Œ |

**æ€»è®¡**: 15ä¸ªæ–‡ä»¶ï¼Œ69+æµ‹è¯•ç”¨ä¾‹ï¼Œ~3,000è¡Œ

### æ¶æ„ç‰¹ç‚¹

1. **ä¼ è¾“æ— å…³æ€§**: åº”ç”¨ä»£ç åªä¾èµ–ç»Ÿä¸€APIï¼Œä¸æ„ŸçŸ¥åº•å±‚ä¼ è¾“
2. **åŒé‡é›†æˆæ–¹å¼**: 
   - æ‰‹åŠ¨ç»‘å®š (dbus/, someip/) - å®Œå…¨æ§åˆ¶
   - CommonAPIé€‚é… (commonapi/) - IDLé©±åŠ¨
3. **RAIIèµ„æºç®¡ç†**: è‡ªåŠ¨æ¸…ç†è¿æ¥ã€Socketã€å†…å­˜
4. **ç±»å‹å®‰å…¨**: æ¨¡æ¿åŒ–è®¾è®¡ï¼Œç¼–è¯‘æœŸç±»å‹æ£€æŸ¥
5. **å¼‚æ­¥ä¼˜å…ˆ**: æ‰€æœ‰é•¿æ—¶é—´æ“ä½œæ”¯æŒå¼‚æ­¥ç‰ˆæœ¬

### ä»£ç ç»„ç»‡

```
modules/Com/
â”œâ”€â”€ source/
â”‚   â”œâ”€â”€ inc/                      # å…¬å…±API (8ä¸ªå¤´æ–‡ä»¶, ~3,140è¡Œ)
â”‚   â””â”€â”€ binding/                  # ä¼ è¾“ç»‘å®š
â”‚       â”œâ”€â”€ dbus/                 # D-Bus (4ä¸ªæ–‡ä»¶, ~950è¡Œ)
â”‚       â”œâ”€â”€ someip/               # SOME/IP (4ä¸ªæ–‡ä»¶, ~1,590è¡Œ)
â”‚       â””â”€â”€ commonapi/            # é€‚é…å™¨ (2ä¸ªæ–‡ä»¶, ~770è¡Œ)
â”œâ”€â”€ test/
â”‚   â”œâ”€â”€ unittest/                 # å•å…ƒæµ‹è¯• (6ä¸ªæ–‡ä»¶, ~1,800è¡Œ)
â”‚   â””â”€â”€ examples/                 # ç¤ºä¾‹ (9ä¸ªæ–‡ä»¶, ~1,200è¡Œ)
â””â”€â”€ tools/
    â”œâ”€â”€ fidl/                     # Franca IDLå®šä¹‰
    â”œâ”€â”€ commonapi/                # ä»£ç ç”Ÿæˆè„šæœ¬
    â””â”€â”€ someip/                   # vsomeipé…ç½®

æ€»è®¡: 41ä¸ªæ–‡ä»¶, ~10,790è¡Œä»£ç 
```

---

## é—®é¢˜2: D-Buså’ŒSOME/IPä¸­çš„åºåˆ—åŒ–æ˜¯å¦å·²ç»åœ¨å¤–éƒ¨è§£å†³ï¼Ÿ

### ç­”æ¡ˆ: æ˜¯çš„ï¼Œå®Œå…¨ç”±å¤–éƒ¨åº“å¤„ç† âœ…

### D-Busåºåˆ—åŒ– (sdbus-c++)

**å¤„ç†æ–¹å¼**: ç”±`sdbus-c++`åº“**è‡ªåŠ¨**å®Œæˆ

```cpp
// åº”ç”¨å±‚ä»£ç  - æ— éœ€æ‰‹åŠ¨åºåˆ—åŒ–
struct VehicleSpeed {
    float current;
    float average;
    uint32_t timestamp;
};

// sdbus-c++è‡ªåŠ¨å¤„ç†æ‰€æœ‰åºåˆ—åŒ–
auto signal = connection->createSignal("/path", "interface", "signal");
signal << speed.current << speed.average << speed.timestamp;  // è‡ªåŠ¨åºåˆ—åŒ–
signal.send();

// æ¥æ”¶ç«¯ä¹Ÿè‡ªåŠ¨ååºåˆ—åŒ–
void onSignal(sdbus::Signal& signal) {
    VehicleSpeed speed;
    signal >> speed.current >> speed.average >> speed.timestamp;  // è‡ªåŠ¨ååºåˆ—åŒ–
}
```

**ç‰¹ç‚¹**:
- âœ… é›¶æ‰‹åŠ¨ä»£ç : ä½¿ç”¨`operator<<`å’Œ`operator>>`é‡è½½
- âœ… ç±»å‹å®‰å…¨: ç¼–è¯‘æœŸç±»å‹æ£€æŸ¥
- âœ… é«˜æ•ˆ: ç›´æ¥æ˜ å°„åˆ°D-Busç±»å‹ç³»ç»Ÿ
- âœ… æ”¯æŒå¤æ‚ç±»å‹: Struct, Array, Dict, Variant

**åº•å±‚æœºåˆ¶**:
```
C++ struct â†’ sdbus-c++ â†’ D-Bus Message â†’ D-Bus Wire Format
                â†‘                              â†“
           è‡ªåŠ¨marshalling               è‡ªåŠ¨unmarshalling
```

### SOME/IPåºåˆ—åŒ– (CommonAPI)

**å¤„ç†æ–¹å¼**: ç”±CommonAPIä»£ç ç”Ÿæˆå™¨**è‡ªåŠ¨ç”Ÿæˆ**åºåˆ—åŒ–ä»£ç 

```cpp
// 1. å®šä¹‰Franca IDL
// VehicleSpeed.fidl
struct VehicleSpeed {
    Float current
    Float average
    UInt32 timestamp
}

// 2. è¿è¡Œä»£ç ç”Ÿæˆå™¨
$ commonapi-someip-generator -sk VehicleSpeed.fidl

// 3. ç”Ÿæˆçš„ä»£ç  (è‡ªåŠ¨ï¼Œæ— éœ€æ‰‹å†™)
namespace CommonAPI {
namespace SomeIP {
    // è‡ªåŠ¨ç”Ÿæˆçš„åºåˆ—åŒ–å™¨
    template<>
    struct Serializer<VehicleSpeed> {
        static void serialize(OutputStream& output, const VehicleSpeed& value) {
            output << value.current << value.average << value.timestamp;
        }
        
        static void deserialize(InputStream& input, VehicleSpeed& value) {
            input >> value.current >> value.average >> value.timestamp;
        }
    };
}
}
```

**åº”ç”¨å±‚ä½¿ç”¨** (å®Œå…¨é€æ˜):
```cpp
// å‘é€ç«¯ - æ— éœ€æ‰‹åŠ¨åºåˆ—åŒ–
VehicleSpeed speed{100.5f, 95.3f, 123456};
myProxy->getSpeedAttribute().setValue(speed);  // è‡ªåŠ¨åºåˆ—åŒ–

// æ¥æ”¶ç«¯ - è‡ªåŠ¨ååºåˆ—åŒ–
myProxy->getSpeedAttribute().getChangedEvent().subscribe([](const VehicleSpeed& speed) {
    // speedå·²ç»æ˜¯ååºåˆ—åŒ–åçš„å¯¹è±¡
    std::cout << "Speed: " << speed.current << std::endl;
});
```

**ç‰¹ç‚¹**:
- âœ… IDLé©±åŠ¨: ä»Franca IDLç”Ÿæˆä¸€åˆ‡
- âœ… é›¶æ‰‹åŠ¨ä»£ç : åºåˆ—åŒ–é€»è¾‘å®Œå…¨è‡ªåŠ¨ç”Ÿæˆ
- âœ… åè®®å…¼å®¹: `.fdepl`æ–‡ä»¶å®šä¹‰SOME/IPåè®®æ˜ å°„
- âœ… é«˜æ€§èƒ½: ç”Ÿæˆçš„ä»£ç ç»è¿‡ä¼˜åŒ–

**åº•å±‚æœºåˆ¶**:
```
Franca IDL â†’ CommonAPI Generator â†’ C++ Serializer/Deserializer
                                          â†“
                                    SOME/IP Wire Format
```

### LightAP Serialization.hppçš„ä½œç”¨

**å½“å‰å®šä½**: æ¥å£å®šä¹‰å±‚ï¼Œ**ä¸ç”¨äºD-Buså’ŒSOME/IP**

```cpp
// Serialization.hppå®šä¹‰ç»Ÿä¸€æ¥å£
class Serializer {
public:
    virtual SerializationFormat GetFormat() const = 0;
    virtual Result<void> Serialize(int32_t value) = 0;
    // ...
};

// æä¾›åŸºç¡€å®ç° (ç”¨äºæµ‹è¯•å’Œç®€å•åœºæ™¯)
class BinarySerializer : public Serializer {
    // æ‰‹åŠ¨äºŒè¿›åˆ¶åºåˆ—åŒ–
};
```

**é€‚ç”¨åœºæ™¯**:
- âŒ **ä¸ç”¨äºD-Bus**: sdbus-c++å·²è‡ªåŠ¨å¤„ç†
- âŒ **ä¸ç”¨äºSOME/IP**: CommonAPIå·²è‡ªåŠ¨ç”Ÿæˆ
- âœ… **ç”¨äºæœªæ¥æ‰©å±•**: Protobufã€è‡ªå®šä¹‰åè®®ç­‰
- âœ… **ç”¨äºæµ‹è¯•**: BinarySerializerç”¨äºå•å…ƒæµ‹è¯•
- âœ… **æ¥å£å®šä¹‰**: ä¸ºæ–°ä¼ è¾“å±‚æä¾›ç»Ÿä¸€æŠ½è±¡

### åºåˆ—åŒ–æµç¨‹å¯¹æ¯”

| ä¼ è¾“å±‚ | åºåˆ—åŒ–å®ç° | å¼€å‘è€…å·¥ä½œé‡ | æ€§èƒ½ |
|--------|-----------|-------------|------|
| **D-Bus** | sdbus-c++è‡ªåŠ¨ | 0 (åªéœ€å®šä¹‰struct) | é«˜ |
| **SOME/IP** | CommonAPIç”Ÿæˆ | 0 (åªéœ€å†™.fidl) | æé«˜ |
| **Protobuf** (è®¡åˆ’ä¸­) | Protobufç¼–è¯‘å™¨ | ä½ (å†™.proto) | æé«˜ |
| **è‡ªå®šä¹‰** (è®¡åˆ’ä¸­) | ç»§æ‰¿Serializer | é«˜ (æ‰‹åŠ¨å®ç°) | å¯æ§ |

### æ€»ç»“

**å…³é”®ç»“è®º**:

1. âœ… **D-Busåºåˆ—åŒ–**: å®Œå…¨ç”±`sdbus-c++`å¤–éƒ¨å¤„ç†ï¼Œåº”ç”¨å±‚é›¶ä»£ç 
2. âœ… **SOME/IPåºåˆ—åŒ–**: å®Œå…¨ç”±CommonAPIç”Ÿæˆä»£ç å¤„ç†ï¼Œåº”ç”¨å±‚é›¶ä»£ç 
3. âœ… **Serialization.hpp**: ä»…ä¸ºæœªæ¥æ‰©å±•æä¾›æ¥å£ï¼Œå½“å‰D-Buså’ŒSOME/IPä¸ä½¿ç”¨

**ä¼˜åŠ¿**:
- å¼€å‘è€…æ— éœ€å…³å¿ƒåºåˆ—åŒ–ç»†èŠ‚
- é¿å…æ‰‹åŠ¨åºåˆ—åŒ–é”™è¯¯
- æ€§èƒ½ç»è¿‡ä¼˜åŒ–
- æ ‡å‡†å…¼å®¹æ€§ä¿è¯

---

## é—®é¢˜3: å¦‚ä½•å¢åŠ Protobufå’Œè‡ªå®šä¹‰ç§æœ‰åè®®æ”¯æŒï¼Ÿ

### æ‰©å±•æ¶æ„è®¾è®¡

åŸºäºç°æœ‰æ¶æ„ï¼Œæ·»åŠ æ–°ä¼ è¾“å±‚éµå¾ª**ç›¸åŒçš„æ¨¡å¼**ï¼š

```
ç°æœ‰æ¶æ„                          æ‰©å±•åæ¶æ„
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Public API  â”‚               â”‚    Public API        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“                                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ D-Bus Bind   â”‚SOME/IP   â”‚   â”‚DBusâ”‚SomeIPâ”‚Socketâ”‚Protobufâ”‚Custom  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“                                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ sdbus-c++    â”‚vsomeip+  â”‚   â”‚sdbuâ”‚vsomeiâ”‚Unix  â”‚Protobufâ”‚è‡ªå®šä¹‰   â”‚
â”‚              â”‚CommonAPI â”‚   â”‚s-c++â”‚p+APIâ”‚Socketâ”‚Library â”‚ç¼–è§£ç å™¨ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ‰©å±•æ–¹æ¡ˆ1: Protobuf over Unix Socket

**ç›®æ ‡**: é«˜æ€§èƒ½æœ¬åœ°è¿›ç¨‹é—´é€šä¿¡

#### æ ¸å¿ƒç»„ä»¶

1. **SocketConnectionManager** - Unix Socketè¿æ¥ç®¡ç†
2. **ProtobufSerializer** - Protobufåºåˆ—åŒ–å™¨
3. **SocketMethodBinding** - æ–¹æ³•ç»‘å®š
4. **SocketEventBinding** - äº‹ä»¶ç»‘å®š
5. **SocketFieldBinding** - å­—æ®µç»‘å®š

#### ç›®å½•ç»“æ„

```
modules/Com/source/binding/socket/
â”œâ”€â”€ SocketConnectionManager.hpp    # Socketç®¡ç†
â”œâ”€â”€ ProtobufSerializer.hpp         # Protobufåºåˆ—åŒ–
â”œâ”€â”€ SocketMethodBinding.hpp        # æ–¹æ³•ç»‘å®š
â”œâ”€â”€ SocketEventBinding.hpp         # äº‹ä»¶ç»‘å®š
â””â”€â”€ SocketFieldBinding.hpp         # å­—æ®µç»‘å®š
```

#### ä½¿ç”¨æµç¨‹

```cpp
// 1. å®šä¹‰Protobufæ¶ˆæ¯
// calculator.proto
message CalculateRequest {
    double operand1 = 1;
    double operand2 = 2;
    string operation = 3;
}

message CalculateResponse {
    double result = 1;
}

// 2. ç”ŸæˆC++ä»£ç 
$ protoc --cpp_out=. calculator.proto

// 3. æœåŠ¡ç«¯å®ç°
SocketMethodResponder<CalculateRequest, CalculateResponse> responder(
    endpoint,
    [](const CalculateRequest& req) -> CalculateResponse {
        CalculateResponse resp;
        if (req.operation() == "add") {
            resp.set_result(req.operand1() + req.operand2());
        }
        return resp;
    }
);
responder.start();

// 4. å®¢æˆ·ç«¯è°ƒç”¨
SocketMethodCaller<CalculateRequest, CalculateResponse> caller(endpoint);
CalculateRequest request;
request.set_operand1(10);
request.set_operand2(5);
request.set_operation("add");

auto result = caller.call(request);
if (result.HasValue()) {
    std::cout << "Result: " << result.Value().result() << std::endl;
}
```

#### å…³é”®è®¾è®¡å†³ç­–

| æ–¹é¢ | å†³ç­– | ç†ç”± |
|------|------|------|
| ä¼ è¾“å±‚ | Unix Domain Socket | é›¶ç½‘ç»œå¼€é”€ï¼Œé«˜æ€§èƒ½ |
| åºåˆ—åŒ– | Protobuf | æˆç†Ÿã€é«˜æ•ˆã€è·¨è¯­è¨€ |
| å¸§æ ¼å¼ | Length-Delimited | 4å­—èŠ‚é•¿åº¦ + Protobuf payload |
| è¿æ¥æ¨¡å¼ | SOCK_STREAM | å¯é ã€æœ‰åºã€é¢å‘è¿æ¥ |
| çº¿ç¨‹æ¨¡å‹ | æ¯è¿æ¥ä¸€çº¿ç¨‹ | ç®€åŒ–å®ç°ï¼Œåç»­å¯ä¼˜åŒ– |

#### æ€§èƒ½ç›®æ ‡

- å»¶è¿Ÿ: < 100Î¼s (æœ¬åœ°é€šä¿¡)
- ååé‡: > 100k msg/s (å°æ¶ˆæ¯)
- ååé‡: > 1GB/s (å¤§æ¶ˆæ¯)

### æ‰©å±•æ–¹æ¡ˆ2: è‡ªå®šä¹‰ç§æœ‰åè®®

**ç›®æ ‡**: æè‡´æ€§èƒ½ï¼Œçµæ´»å®šåˆ¶

#### åè®®è®¾è®¡

```
LightAP Custom Protocol Frame Format:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Magic   â”‚ Version â”‚ Flags   â”‚ Length   â”‚ Payload  â”‚  CRC   â”‚
â”‚ (4B)    â”‚ (1B)    â”‚ (1B)    â”‚ (4B)     â”‚ (N bytes)â”‚ (4B)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Magic:   0x4C415000 ('LAP\0')
Version: 0x01
Flags:   bit0: Compressed
         bit1: Encrypted
         bit2-3: Priority (0-3)
         bit4-5: Message Type (Request/Response/Event/Notification)
Length:  Payload length (big-endian)
CRC:     CRC32 checksum
```

#### æ ¸å¿ƒç»„ä»¶

1. **CustomProtocol.hpp** - åè®®å®šä¹‰
2. **CustomCodec.hpp** - ç¼–è§£ç å™¨ (å«CRCã€å‹ç¼©)
3. **CustomTransport.hpp** - ä¼ è¾“å±‚æŠ½è±¡
4. **TcpTransport / UdpTransport / ShmTransport** - å…·ä½“ä¼ è¾“å®ç°
5. **CustomMethodBinding / CustomEventBinding / CustomFieldBinding**

#### ç›®å½•ç»“æ„

```
modules/Com/source/binding/custom/
â”œâ”€â”€ CustomProtocol.hpp          # åè®®å®šä¹‰
â”œâ”€â”€ CustomCodec.hpp             # ç¼–è§£ç å™¨
â”œâ”€â”€ CustomTransport.hpp         # ä¼ è¾“æŠ½è±¡
â”œâ”€â”€ TcpTransport.hpp            # TCPå®ç°
â”œâ”€â”€ UdpTransport.hpp            # UDPå®ç°
â”œâ”€â”€ ShmTransport.hpp            # å…±äº«å†…å­˜å®ç°
â”œâ”€â”€ CustomMethodBinding.hpp     # æ–¹æ³•ç»‘å®š
â”œâ”€â”€ CustomEventBinding.hpp      # äº‹ä»¶ç»‘å®š
â””â”€â”€ CustomFieldBinding.hpp      # å­—æ®µç»‘å®š
```

#### ç‰¹è‰²åŠŸèƒ½

1. **å¤šä¼ è¾“æ”¯æŒ**:
   - TCP: å¯é ã€è·¨ç½‘ç»œ
   - UDP: ä½å»¶è¿Ÿã€å¹¿æ’­
   - å…±äº«å†…å­˜: æè‡´æ€§èƒ½

2. **çµæ´»åºåˆ—åŒ–**:
   - ç»§æ‰¿`Serialization.hpp`æ¥å£
   - å¯é€‰å‹ç¼© (LZ4/Zstd)
   - å¯é€‰åŠ å¯† (AES)

3. **å¯é æ€§æœºåˆ¶**:
   - CRC32æ ¡éªŒ
   - å¯é€‰é‡ä¼ 
   - è¶…æ—¶å¤„ç†

4. **æ€§èƒ½ä¼˜åŒ–**:
   - é›¶æ‹·è´ä¼ è¾“
   - æ‰¹é‡å‘é€
   - ä¼˜å…ˆçº§é˜Ÿåˆ—

#### ä½¿ç”¨ç¤ºä¾‹

```cpp
// 1. é€‰æ‹©ä¼ è¾“å±‚
auto transport = std::make_unique<TcpTransport>();  // æˆ– UdpTransport, ShmTransport

// 2. åˆ›å»ºæ–¹æ³•å“åº”å™¨
CustomMethodResponder<MyRequest, MyResponse> responder(
    std::move(transport),
    "0.0.0.0:8080",
    [](const MyRequest& req) -> MyResponse {
        // å¤„ç†è¯·æ±‚
        return MyResponse{};
    }
);
responder.start();

// 3. å®¢æˆ·ç«¯è°ƒç”¨
auto clientTransport = std::make_unique<TcpTransport>();
CustomMethodCaller<MyRequest, MyResponse> caller(
    std::move(clientTransport),
    "127.0.0.1:8080"
);

MyRequest request;
auto result = caller.call(request);
```

#### æ€§èƒ½ç›®æ ‡

- å»¶è¿Ÿ: < 10Î¼s (å…±äº«å†…å­˜)
- ååé‡: > 500k msg/s (å°æ¶ˆæ¯)
- å‹ç¼©ç‡: > 50% (æ–‡æœ¬æ•°æ®)

### å®æ–½è·¯çº¿å›¾

#### Phase 1: Protobuf over Socket (2-3å‘¨)

**Week 1: æ ¸å¿ƒåŸºç¡€**
- [ ] SocketConnectionManagerå®ç° (3å¤©)
- [ ] ProtobufSerializerå®ç° (2å¤©)

**Week 2: ç»‘å®šå±‚**
- [ ] SocketMethodBinding (3å¤©)
- [ ] SocketEventBinding (2å¤©)
- [ ] SocketFieldBinding (2å¤©)

**Week 3: æµ‹è¯•ä¸æ–‡æ¡£**
- [ ] å•å…ƒæµ‹è¯• (è¦†ç›–ç‡ > 80%)
- [ ] é›†æˆæµ‹è¯• (ç«¯åˆ°ç«¯)
- [ ] æ€§èƒ½åŸºå‡†æµ‹è¯•
- [ ] APIæ–‡æ¡£å’Œç¤ºä¾‹

#### Phase 2: è‡ªå®šä¹‰åè®® (3-4å‘¨)

**Week 1: åè®®åŸºç¡€**
- [ ] åè®®è§„èŒƒå®šä¹‰
- [ ] CustomCodecå®ç° (å«CRC)
- [ ] å‹ç¼©/è§£å‹ç¼©æ”¯æŒ

**Week 2-3: ä¼ è¾“å±‚**
- [ ] TCP Transport
- [ ] UDP Transport
- [ ] SharedMemory Transport
- [ ] ä¼ è¾“å±‚å·¥å‚æ¨¡å¼

**Week 4: ç»‘å®šä¸ä¼˜åŒ–**
- [ ] Method/Event/Field Binding
- [ ] æ€§èƒ½ä¼˜åŒ– (é›¶æ‹·è´ã€æ‰¹é‡å¤„ç†)
- [ ] å®Œæ•´æµ‹è¯•å’Œæ–‡æ¡£

### é›†æˆåˆ°ç°æœ‰æ¶æ„

æ–°ä¼ è¾“å±‚ä¸ç°æœ‰ç»„ä»¶çš„å…³ç³»ï¼š

```
åº”ç”¨å±‚ä»£ç 
    â†“ (ä½¿ç”¨ç›¸åŒçš„API)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  lap::com::Runtime                          â”‚
â”‚  lap::com::ProxyBase / SkeletonBase        â”‚
â”‚  lap::com::Method / Event / Field          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â†“               â†“               â†“               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ D-Bus  â”‚  â”‚  SOME/IP    â”‚  â”‚ Socket   â”‚  â”‚ Custom   â”‚
â”‚ Bindingâ”‚  â”‚  Binding    â”‚  â”‚ Binding  â”‚  â”‚ Binding  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“               â†“               â†“               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚sdbus-  â”‚  â”‚vsomeip +    â”‚  â”‚Protobuf +â”‚  â”‚è‡ªå®šä¹‰ç¼–  â”‚
â”‚c++     â”‚  â”‚CommonAPI    â”‚  â”‚Unix Sock â”‚  â”‚è§£ç å™¨    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…³é”®ç‚¹**:
- âœ… åº”ç”¨å±‚ä»£ç æ— éœ€ä¿®æ”¹
- âœ… ç»Ÿä¸€çš„é”™è¯¯å¤„ç† (Result<T>)
- âœ… ç»Ÿä¸€çš„å¼‚æ­¥æ¨¡å‹ (callback/future)
- âœ… ç»Ÿä¸€çš„ç”Ÿå‘½å‘¨æœŸç®¡ç† (RAII)

### å¯¹æ¯”åˆ†æ

| ç‰¹æ€§ | D-Bus | SOME/IP | Protobuf+Socket | è‡ªå®šä¹‰åè®® |
|------|-------|---------|-----------------|-----------|
| **å»¶è¿Ÿ** | ä¸­ (1-5ms) | ä½ (100Î¼s) | æä½ (<100Î¼s) | æä½ (<10Î¼s) |
| **ååé‡** | ä¸­ | é«˜ | æé«˜ | æé«˜ |
| **é€‚ç”¨èŒƒå›´** | ç³»ç»ŸIPC | è½¦è½½ç½‘ç»œ | æœ¬åœ°é«˜æ€§èƒ½ | çµæ´»å®šåˆ¶ |
| **å¼€å‘å¤æ‚åº¦** | ä½ | ä¸­ | ä½ | é«˜ |
| **åºåˆ—åŒ–** | sdbus-c++ | CommonAPI | Protobuf | è‡ªå®šä¹‰ |
| **è·¨è¯­è¨€** | æ˜¯ | æ˜¯ | æ˜¯ | å¯é€‰ |
| **ç°æœ‰çŠ¶æ€** | âœ… å®Œæˆ | âœ… å®Œæˆ | ğŸ“‹ è®¡åˆ’ä¸­ | ğŸ“‹ è®¡åˆ’ä¸­ |

### æ–‡æ¡£å’Œå·¥å…·

æ‰©å±•å®Œæˆåå°†æä¾›ï¼š

1. **æ¶æ„æ–‡æ¡£** (å·²å®Œæˆ)
   - `doc/COM_ARCHITECTURE.md` - æ•´ä½“æ¶æ„è¯´æ˜
   - `doc/EXTENSION_GUIDE.md` - æ‰©å±•å®ç°æŒ‡å—

2. **APIæ–‡æ¡£** (å¾…ç”Ÿæˆ)
   - Doxygenç”Ÿæˆçš„è¯¦ç»†APIæ–‡æ¡£

3. **ç”¨æˆ·æŒ‡å—** (å¾…ç¼–å†™)
   - å¿«é€Ÿå…¥é—¨
   - æœ€ä½³å®è·µ
   - æ€§èƒ½è°ƒä¼˜

4. **å¼€å‘å·¥å…·** (å¾…å®ç°)
   - åè®®åˆ†æå·¥å…· (ç”¨äºè°ƒè¯•è‡ªå®šä¹‰åè®®)
   - æ€§èƒ½åŸºå‡†æµ‹è¯•å¥—ä»¶
   - ä»£ç ç”Ÿæˆæ¨¡æ¿

---

## æ€»ç»“

### å½“å‰çŠ¶æ€

âœ… **å·²å®Œæˆ**: 10,790è¡Œä»£ç ï¼Œå®Œæ•´çš„D-Buså’ŒSOME/IPæ”¯æŒ  
âœ… **æ¶æ„æ¸…æ™°**: åˆ†å±‚è®¾è®¡ï¼Œæ˜“äºæ‰©å±•  
âœ… **åºåˆ—åŒ–å¤–éƒ¨åŒ–**: D-Buså’ŒSOME/IPæ— éœ€æ‰‹åŠ¨åºåˆ—åŒ–  
âœ… **æµ‹è¯•å®Œå–„**: 69+æµ‹è¯•ç”¨ä¾‹ï¼Œå¤šä¸ªå®Œæ•´ç¤ºä¾‹  

### æ‰©å±•è®¡åˆ’

ğŸ“‹ **Phase 1**: Protobuf over Unix Socket (2-3å‘¨)
- é«˜æ€§èƒ½æœ¬åœ°IPC
- æˆç†Ÿçš„åºåˆ—åŒ–æ–¹æ¡ˆ
- æ˜“äºé›†æˆ

ğŸ“‹ **Phase 2**: è‡ªå®šä¹‰ç§æœ‰åè®® (3-4å‘¨)
- æè‡´æ€§èƒ½ä¼˜åŒ–
- çµæ´»å®šåˆ¶
- å¤šä¼ è¾“æ”¯æŒ

### å…³é”®ä¼˜åŠ¿

1. **æ¶æ„æ‰©å±•æ€§**: æ¸…æ™°çš„æ‰©å±•ç‚¹ï¼Œæ·»åŠ æ–°ä¼ è¾“å±‚ä¸å½±å“ç°æœ‰ä»£ç 
2. **åºåˆ—åŒ–çµæ´»æ€§**: æ—¢æ”¯æŒå¤–éƒ¨åº“(sdbus-c++, Protobuf)ï¼Œä¹Ÿæ”¯æŒè‡ªå®šä¹‰å®ç°
3. **æ€§èƒ½å¯æ§**: ä»é€šç”¨(D-Bus)åˆ°æè‡´(è‡ªå®šä¹‰åè®®)çš„å®Œæ•´è¦†ç›–
4. **å¼€å‘å‹å¥½**: ç»Ÿä¸€APIï¼Œä¸°å¯Œæ–‡æ¡£ï¼Œå®Œæ•´ç¤ºä¾‹

### ä¸‹ä¸€æ­¥

1. âœ… Reviewæ¶æ„æ–‡æ¡£ (`COM_ARCHITECTURE.md`)
2. âœ… Reviewæ‰©å±•æŒ‡å— (`EXTENSION_GUIDE.md`)
3. ğŸ“‹ å¼€å§‹å®æ–½ Phase 1: Protobuf over Socket
4. ğŸ“‹ æ€§èƒ½åŸºå‡†æµ‹è¯•
5. ğŸ“‹ ç”Ÿäº§ç¯å¢ƒéªŒè¯

---

**å®Œæ•´æ–‡æ¡£é“¾æ¥**:
- æ¶æ„è¯´æ˜: `modules/Com/doc/COM_ARCHITECTURE.md`
- æ‰©å±•æŒ‡å—: `modules/Com/doc/EXTENSION_GUIDE.md`

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**æœ€åæ›´æ–°**: 2025-10-30  
**ç»´æŠ¤è€…**: LightAP Team
