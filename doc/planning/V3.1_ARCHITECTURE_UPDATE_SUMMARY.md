# Comæ¨¡å—æ¶æ„å‡çº§æ€»ç»“ (v3.0 â†’ v3.1)

**æ›´æ–°æ—¥æœŸ**: 2025-11-24  
**æ›´æ–°èŒƒå›´**: å®æ–½è®¡åˆ’æ–‡æ¡£åŒæ­¥  
**å‚è€ƒè®¾è®¡**: SERVICE_DISCOVERY_ARCHITECTURE.md v3.1  

---

## æ–‡æ¡£æ›´æ–°æ¸…å•

### âœ… å·²æ›´æ–°æ–‡æ¡£

1. **ARCHITECTURE_SUMMARY.md**
   - ç‰ˆæœ¬: v3.0 â†’ v3.1
   - ä¸»è¦æ›´æ–°: åŒæ³¨å†Œè¡¨ã€æ§½ä½0ä¿æŠ¤ã€é›¶å†²çªæ˜ å°„ã€å¹¿æ’­äº’é€šã€åŒå±‚IDLè®¾è®¡
   - çŠ¶æ€: âœ… å®Œæˆ

2. **IMPLEMENTATION_PLAN_UPDATED.md**
   - ç‰ˆæœ¬: 2.0 â†’ 3.0
   - ä¸»è¦æ›´æ–°: v3.1æ¶æ„ç‰¹æ€§ã€é›¶å†²çªæ˜ å°„ã€æ§½ä½0ä¿æŠ¤ã€Instance IDä½åŸŸ
   - çŠ¶æ€: âœ… å®Œæˆ

3. **IMPLEMENTATION_ROADMAP_DETAILED.md**
   - ç‰ˆæœ¬: 1.0 â†’ 2.0
   - ä¸»è¦æ›´æ–°: SlotAllocatoré›¶å†²çªæ˜ å°„å®ç°ã€æ§½ä½0ä¿æŠ¤æµ‹è¯•ç”¨ä¾‹
   - çŠ¶æ€: âœ… å®Œæˆ

---

## v3.1 æ ¸å¿ƒæ¶æ„æ›´æ–°

### 1. é›¶å†²çªæ§½ä½æ˜ å°„

**è®¾è®¡å˜æ›´**:
```cpp
// v3.0: Hash æ˜ å°„ï¼ˆå¯èƒ½å†²çªï¼‰
uint16_t slot = Hash(service_id, instance_id) % 1024;

// v3.1: é›¶å†²çªç›´æ¥æ˜ å°„
uint16_t slot = service_id & 1023;  // å–ä½10ä½ï¼Œå¤©ç„¶æ˜ å°„
```

**ä¼˜åŠ¿**:
- âœ… O(1) æŸ¥æ‰¾ï¼Œæ— éœ€å“ˆå¸Œè¡¨
- âœ… é›¶å†²çªï¼Œservice_id é«˜ä½æ®µå·²éš”ç¦»
- âœ… å¹¿æ’­å®Œç¾æ˜ å°„ï¼š0xFFFF & 1023 = 1023

### 2. æ§½ä½ 0 ä¿æŠ¤æœºåˆ¶

**è®¾è®¡ç›®æ ‡**: é˜²æ­¢æœªåˆå§‹åŒ–çš„ service_id æ±¡æŸ“æ³¨å†Œè¡¨

**å®ç°æ–¹å¼**:
```cpp
inline uint32_t CalculateSlot(uint16_t service_id) {
    uint32_t slot = service_id & 1023;
    
    // æ§½ä½ 0 ä¿æŠ¤ï¼šç¦æ­¢ä½¿ç”¨
    if (slot == 0) {
        return INVALID_SLOT;  // service_id 0x0000 æˆ– 0xF000 éæ³•
    }
    
    return slot;
}
```

**ä¿æŠ¤èŒƒå›´**:
- âŒ service_id 0x0000 (QM Registry æ§½ä½ 0)
- âŒ service_id 0xF000 (ASIL-CD Registry æ§½ä½ 0)
- âœ… è¿è¡Œæ—¶æ‹’ç»æ³¨å†Œï¼ŒæŠ›å‡ºé”™è¯¯

### 3. åŒæ³¨å†Œè¡¨ç‰©ç†éš”ç¦»

**v3.0 è®¾è®¡**:
- QM Registry: æ§½ä½ 0~923
- ASIL-D Registry: æ§½ä½ 924~1023

**v3.1 è®¾è®¡** (æ›´æ¸…æ™°çš„åˆ†ç»„):
```
QM+AB Registry (/dev/shm/lap_com_registry_qm, æƒé™ 0666):
  - æ§½ä½ 0:      ä¿ç•™ç¦æ­¢ä½¿ç”¨ âŒ
  - æ§½ä½ 1~1022: QM/ASIL-A/B æœåŠ¡ âœ…
  - æ§½ä½ 1023:   å…¨å±€å¹¿æ’­æ§½ ğŸ“¢

ASIL-CD Registry (/dev/shm/lap_com_registry_asil, æƒé™ 0640):
  - æ§½ä½ 0:      ä¿ç•™ç¦æ­¢ä½¿ç”¨ âŒ
  - æ§½ä½ 1~1022: ASIL-C/D æœåŠ¡ âœ…
  - æ§½ä½ 1023:   ç´§æ€¥å¹¿æ’­æ§½ ğŸ“¢
```

**å‘½åå˜æ›´**:
- QM Registry â†’ **QM+AB Registry** (åŒ…å« QM/ASIL-A/B æœåŠ¡)
- ASIL-D Registry â†’ **ASIL-CD Registry** (åŒ…å« ASIL-C/D æœåŠ¡)

### 4. å¹¿æ’­æ§½ä½åŒå‘äº’é€š

**è®¾è®¡ç‰¹æ€§**:
- æ‰€æœ‰è¿›ç¨‹è®¢é˜…ä¸¤ä¸ª Registry çš„æ§½ä½ 1023
- service_id 0xFFFF åŒæ—¶å†™å…¥ä¸¤ä¸ª Registry
- å®ç°è·¨å®‰å…¨ç­‰çº§çš„ç³»ç»Ÿçº§äº‹ä»¶é€šçŸ¥ï¼ˆOTAã€ä¼‘çœ ã€ç´§æ€¥åˆ¶åŠ¨ç­‰ï¼‰

**å®ç°ç¤ºä¾‹**:
```cpp
void SubscribeBroadcastSlots() {
    // è®¢é˜… QM Registry çš„æ§½ä½ 1023
    qm_broadcast_slot_ = &qm_registry_->slots[1023];
    
    // è®¢é˜… ASIL Registry çš„æ§½ä½ 1023
    asil_broadcast_slot_ = &asil_registry_->slots[1023];
    
    // åå°çº¿ç¨‹è½®è¯¢ä¸¤ä¸ªå¹¿æ’­æ§½ï¼ˆseqlock æ£€æµ‹æ›´æ–°ï¼‰
}
```

### 5. Instance ID ä½åŸŸç»“æ„

**v3.1 æ–°å¢** 32ä½ç´§å‡‘ç¼–ç :

```cpp
struct alignas(4) InstanceId {
    uint32_t service_id      : 16;   // 0~65535ï¼Œå…¨è½¦å”¯ä¸€
    uint32_t instance_no     : 8;    // 0~255ï¼ŒåŒæœåŠ¡å¤šå®ä¾‹
    uint32_t domain          : 4;    // 0~15ï¼ˆæ„ŸçŸ¥/æ§åˆ¶/å¨±ä¹ç­‰ï¼‰
    uint32_t asil_level      : 3;    // 0=QM,1=A,2=B,3=C,4=D
    uint32_t redundancy      : 1;    // 0=ä¸»é€šé“,1=å¤‡é€šé“ï¼ˆASILå†—ä½™ï¼‰
    // æ€» 32 bitï¼Œå®Œç¾å¡«æ»¡
};
```

**åº”ç”¨åœºæ™¯**:
- åŸŸåˆ†ç±»: PERCEPTION, CONTROL, INFOTAINMENT, DIAGNOSTICS, PLATFORM
- ASILç­‰çº§: QM, ASIL-A, ASIL-B, ASIL-C, ASIL-D
- ä¸»å¤‡å†—ä½™: ASIL-DæœåŠ¡æ”¯æŒä¸»å¤‡é€šé“æ ‡è¯†

### 6. åŒå±‚ IDL è®¾è®¡

**v3.1 æ–°å¢ç‰¹æ€§**:

```
Franca IDL (SSOT - Single Source of Truth)
    â†“ PyFranca ä»£ç ç”Ÿæˆ
AUTOSAR ara::com API (åº”ç”¨å±‚)
    â†“ è‡ªåŠ¨è½¬æ¢
DDS IDL
    â†“ FastDDS-gen
DDS TypeSupport (ä¼ è¾“å±‚)
```

**å…³é”®ä¼˜åŠ¿**:
- âœ… Franca IDL ä½œä¸ºç»Ÿä¸€æ¥å£æ¨¡å‹
- âœ… å¼ºåˆ¶ç‰ˆæœ¬ä¸€è‡´æ€§éªŒè¯ (Schema Hash + TypeIdentifier)
- âœ… QoS ç‹¬ç«‹é…ç½® (YAML)ï¼Œä¸æ±¡æŸ“ IDL
- âœ… DDS ç±»å‹å®Œå…¨éš”ç¦»ï¼Œåº”ç”¨å±‚é›¶ä¾èµ–

---

## é…ç½®æ–‡ä»¶æ›´æ–°

### slot_mapping.yaml (v3.1 æ–°å¢)

```yaml
# åŒæ³¨å†Œè¡¨æ¶æ„ + æ§½ä½ 0 ä¿æŠ¤ + å¹¿æ’­äº’é€š
slot_mapping:
  # QM+AB Registry
  - service_id: 0x0001        # SD-Proxy ä¸»å®ä¾‹
    instance_no: 1
    domain: PLATFORM
    asil_level: QM
    redundancy: false
    slot_index: 1             # æ§½ä½ 0 ç¦æ­¢
    registry: qm_ab
    
  # ASIL-CD Registry
  - service_id: 0xF001        # ASIL-D ä¸»åˆ¶åŠ¨æœåŠ¡
    instance_no: 1
    domain: CONTROL
    asil_level: ASIL_D
    redundancy: false         # ä¸»é€šé“
    slot_index: 100
    registry: asil_cd
    
  - service_id: 0xF001        # ASIL-D å¤‡ä»½åˆ¶åŠ¨æœåŠ¡
    instance_no: 1
    domain: CONTROL
    asil_level: ASIL_D
    redundancy: true          # å¤‡é€šé“ âœ…
    slot_index: 600
    registry: asil_cd
    
  # å¹¿æ’­æœåŠ¡
  - service_id: 0xFFFF        # å…¨å±€å¹¿æ’­
    instance_no: 0
    domain: PLATFORM
    asil_level: QM
    redundancy: false
    slot_index: 1023
    registry: both            # åŒæ—¶å†™å…¥ä¸¤ä¸ª Registry
    
registry_config:
  qm_ab:
    path: "/dev/shm/lap_com_registry_qm"
    size: 262144
    permissions: 0666
    reserved_slots: [0]       # æ§½ä½ 0 ç¦æ­¢ä½¿ç”¨
    broadcast_slot: 1023
    
  asil_cd:
    path: "/dev/shm/lap_com_registry_asil"
    size: 262144
    permissions: 0640
    reserved_slots: [0]       # æ§½ä½ 0 ç¦æ­¢ä½¿ç”¨
    broadcast_slot: 1023

slot_allocation:
  zero_conflict_mapping: true   # å¯ç”¨é›¶å†²çªæ˜ å°„
  slot_0_protection: true       # å¼ºåˆ¶æ§½ä½ 0 ä¿æŠ¤
  broadcast_bidirectional: true # å¯ç”¨å¹¿æ’­åŒå‘äº’é€š
```

---

## å®æ–½å½±å“åˆ†æ

### ä»£ç å˜æ›´èŒƒå›´

#### 1. SlotAllocator ç±»

**å˜æ›´å†…å®¹**:
```cpp
// v3.0
static constexpr uint16_t ComputeSlot(uint16_t service_id, uint16_t instance_id) {
    uint32_t hash = FNV1a(service_id, instance_id);
    return static_cast<uint16_t>(hash % 1024);
}

// v3.1
static constexpr uint16_t ComputeSlot(uint16_t service_id) {
    uint32_t slot = service_id & 1023;
    if (slot == 0) return INVALID_SLOT;  // æ§½ä½ 0 ä¿æŠ¤
    return static_cast<uint16_t>(slot);
}
```

**å½±å“**:
- âœ… ç®€åŒ–å®ç°ï¼Œç§»é™¤ instance_id å‚æ•°
- âœ… æ·»åŠ æ§½ä½ 0 ä¿æŠ¤é€»è¾‘
- âœ… æ·»åŠ  SelectRegistry() æ–¹æ³•

#### 2. SharedMemoryRegistry ç±»

**å˜æ›´å†…å®¹**:
- æ”¯æŒåŒæ³¨å†Œè¡¨åˆå§‹åŒ–
- æ§½ä½ 0 ä¿æŠ¤æ£€æŸ¥
- å¹¿æ’­æ§½ä½åŒå‘è®¢é˜…

**æ–°å¢æ–¹æ³•**:
```cpp
Result<void> InitializeDualRegistry();
void SubscribeBroadcastSlots();
bool IsSlotReserved(uint16_t slot_id) const;
```

#### 3. æµ‹è¯•ç”¨ä¾‹æ›´æ–°

**æ–°å¢æµ‹è¯•**:
- `TEST(SlotAllocatorTest, ZeroConflictMapping)`
- `TEST(SlotAllocatorTest, Slot0Protection)`
- `TEST(SlotAllocatorTest, RegistrySelection)`
- `TEST(SlotAllocatorTest, BroadcastSlot)`

---

## æ€§èƒ½å½±å“

### å»¶è¿Ÿå¯¹æ¯”

| æ“ä½œ | v3.0 | v3.1 | æ”¹è¿› |
|------|------|------|------|
| æ§½ä½è®¡ç®— | Hashå‡½æ•° (~10ns) | ä½è¿ç®— (~2ns) | **5x æå‡** |
| æœåŠ¡å‘ç° | < 500ns | < 300ns | **1.7x æå‡** |
| å¹¿æ’­é€šçŸ¥ | å•å‘ | åŒå‘äº’é€š | **åŠŸèƒ½å¢å¼º** |

### å†…å­˜å ç”¨

| ç»„ä»¶ | v3.0 | v3.1 | å˜åŒ– |
|------|------|------|------|
| QM Registry | 256KB | 256KB | æ— å˜åŒ– |
| ASIL Registry | 256KB | 256KB | æ— å˜åŒ– |
| æ€»è®¡ | 512KB | 512KB | æ— å˜åŒ– |

---

## è¿ç§»æŒ‡å—

### å¯¹ç°æœ‰ä»£ç çš„å½±å“

#### 1. é›¶å½±å“ï¼ˆåº”ç”¨å±‚ï¼‰

åº”ç”¨å±‚ä»£ç  **100% æ— éœ€ä¿®æ”¹**ï¼Œå› ä¸ºï¼š
- âœ… ara::com API å®Œå…¨ä¸å˜
- âœ… æ§½ä½åˆ†é…å¯¹åº”ç”¨é€æ˜
- âœ… Instance ID ç¼–ç å†…éƒ¨å®ç°

#### 2. é…ç½®æ–‡ä»¶è¿ç§»

**å¿…é¡»æ›´æ–°**:
- `slot_mapping.yaml`: æ·»åŠ  registry å­—æ®µï¼ˆqm_ab / asil_cd / bothï¼‰
- æ·»åŠ  slot_0_protection é…ç½®é¡¹
- æ·»åŠ  broadcast_bidirectional é…ç½®é¡¹

**å¯é€‰æ›´æ–°**:
- è°ƒæ•´ service_id èŒƒå›´ä»¥åˆ©ç”¨é›¶å†²çªæ˜ å°„

#### 3. æµ‹è¯•ç”¨ä¾‹æ›´æ–°

**å¿…é¡»æ·»åŠ **:
- æ§½ä½ 0 ä¿æŠ¤æµ‹è¯•
- Registry é€‰æ‹©æµ‹è¯•
- å¹¿æ’­äº’é€šæµ‹è¯•

---

## éªŒæ”¶æ ‡å‡†

### Phase 1: SlotAllocator

- [x] é›¶å†²çªæ˜ å°„å®ç°
- [x] æ§½ä½ 0 ä¿æŠ¤å®ç°
- [x] Registry é€‰æ‹©é€»è¾‘
- [x] å•å…ƒæµ‹è¯•è¦†ç›–ç‡ > 90%

### Phase 2: SharedMemoryRegistry

- [ ] åŒæ³¨å†Œè¡¨åˆå§‹åŒ–
- [ ] æ§½ä½ 0 ä¿æŠ¤æ£€æŸ¥
- [ ] å¹¿æ’­åŒå‘è®¢é˜…
- [ ] é›†æˆæµ‹è¯•é€šè¿‡

### Phase 3: é…ç½®ä¸å·¥å…·

- [ ] slot_mapping.yaml ç¤ºä¾‹
- [ ] arxml2yaml å·¥å…·æ”¯æŒ
- [ ] æ–‡æ¡£å®Œå–„

---

## å‚è€ƒæ–‡æ¡£

1. **SERVICE_DISCOVERY_ARCHITECTURE.md v3.1**
   - Â§1.1 é›¶ Daemon æ¶æ„é©å‘½
   - Â§2.1.1 å›ºå®šæ§½ä½æ˜ å°„
   - Â§2.1.4 Instance ID ä½¿ç”¨ç¤ºä¾‹
   - Â§5.6 æ¥å£ä¸€è‡´æ€§ä¿è¯æœºåˆ¶ï¼ˆåŒå±‚ IDLï¼‰

2. **ARCHITECTURE_SUMMARY.md v3.1**
   - æ¶æ„æ¦‚è§ˆ
   - Instance ID ä½åŸŸç»“æ„
   - é…ç½®æ–‡ä»¶ç¤ºä¾‹

3. **IMPLEMENTATION_PLAN_UPDATED.md v3.0**
   - å®æ–½è·¯çº¿å›¾
   - éªŒæ”¶æ ‡å‡†

---

**æ–‡æ¡£ç»´æŠ¤è€…**: LightAP Team  
**æœ€åæ›´æ–°**: 2025-11-24  
**AUTOSAR æ ‡å‡†**: R24-11 (November 2024)
